{% extends "core/base.html" %}

{% block title %}Lista de Cobranzas{% endblock %}

{% block content %}
<h1>Cobranzas Registradas</h1>

<table border="1" cellpadding="5">
    <tr>
        <th>Paciente</th>
        <th>RUT</th>
        <th>Fecha sesión</th>
        <th>Monto</th>
        <th>Estado</th>
        <th>Fecha de pago</th>
        <th>Acción</th>
    </tr>
    {% for cobranza in cobranzas %}
    <tr>
        <td>{{ cobranza.sesion.paciente.nombre }}</td>
        <td>{{ cobranza.sesion.paciente.rut }}</td>
        <td>{{ cobranza.sesion.fecha }}</td>
        <td>
            {% if cobranza.estado != 'pagado' %}
            <form method="post" action="{% url 'editar_cobranza_inline' cobranza.id %}" style="display:inline;" class="form-monto">
                {% csrf_token %}
                <input type="number" step="0.01" name="monto" 
       value="{% if cobranza.monto|floatformat:2 == '0.00' %}40000{% else %}{{ cobranza.monto }}{% endif %}" 
       style="width:70px;">
                <button type="submit">Actualizar</button>
            </form>
            {% else %}
                ${{ cobranza.monto }}
            {% endif %}
        </td>
        <td>{{ cobranza.estado }}</td>
        <td>{{ cobranza.fecha_pago|default:"-" }}</td>
        <td>
            {% if cobranza.estado != 'pagado' %}
                <a href="{% url 'marcar_pagada' cobranza.id %}">Marcar como pagada</a> |
                <a href="{% url 'enviar_recordatorio' cobranza.id %}">Solicitar cobro</a>
            {% else %}
                Pagado
            {% endif %}
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="7">No hay cobranzas registradas.</td>
    </tr>
    {% endfor %}
</table>

<script>
document.querySelectorAll('.form-monto').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Detener envío automático
        const input = form.querySelector('input[name="monto"]');
        const nuevoMonto = input.value;

        if (confirm(`¿Monto cambiado a ${nuevoMonto}? Confirmar para guardar.`)) {
            form.submit();
        } else {
            input.value = input.defaultValue; // volver al valor anterior
        }
    });
});
</script>
{% endblock %}
